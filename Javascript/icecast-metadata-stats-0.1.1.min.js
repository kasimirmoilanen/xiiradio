/*! 
 * Copyright 2021 Ethan Halsall
 * https://github.com/eshaz/icecast-metadata-js
 *
 * This file is part of icecast-metadata-stats.
 *
 * icecast-metadata-stats free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * icecast-metadata-stats distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>
 */
var IcecastMetadataStats;(()=>{var t={344:t=>{const s=()=>{};t.exports=class{constructor({icyBr:t,onMetadataUpdate:e=s,onMetadataEnqueue:i=s}){this.t=t,this.i=e,this.h=i,this.l=!0,this.u=[]}get metadataQueue(){return this.u.map((({m:t,...s})=>s))}addMetadata({metadata:t,stats:s},e,i=0){this.g(t,e,i+this.getTimeByBytes(s.currentStreamPosition))}getTimeByBytes(t){return this.t?t/(125*this.t):0}purgeMetadataQueue(){this.u.forEach((t=>clearTimeout(t.m))),this.u=[]}g(t,s,e){const i={metadata:t,timestampOffset:s,timestamp:e};this.u.push(i),this.h(t,s,e),this.l?(this.p(),this.l=!1):i.m=setTimeout((()=>{this.p()}),1e3*(s-e))}p(){const{metadata:t,timestampOffset:s,timestamp:e}=this.u.shift();this.i(t,s,e)}}},780:(t,s,e)=>{const i=e(660),a=e(690),r=e(491),n=e(555);t.exports=class{constructor({metadataTypes:t=["icy"],...s}={}){const e=t.includes("icy"),h=t.includes("ogg");this.S=e&&h?new n(s):h?new r(s):e?new a(s):new i(s)}static parseIcyMetadata(t){return a.parseIcyMetadata(t)}get icyMetaInt(){return this.S.icyMetaInt}*iterator(t){yield*this.S.iterator(t)}readAll(t){this.S.readAll(t)}async*asyncIterator(t){return yield*this.S.asyncIterator(t)}async asyncReadAll(t){return this.S.asyncReadAll(t)}}},555:(t,s,e)=>{const i=e(690),a=e(491);t.exports=class{constructor(t){const{onStream:s,...e}=t;this.I=new a(t),this.M=new i(e)}get icyMetaInt(){return this.M.icyMetaInt}*iterator(t){for(const s of this.M.iterator(t))s.stream?yield*this.I.iterator(s.stream):yield s}readAll(t){for(const s of this.M.iterator(t))s.stream&&this.I.readAll(s.stream)}async*asyncIterator(t){for await(const s of this.M.asyncIterator(t))if(s.stream)for await(const t of this.I.asyncIterator(s.stream))yield t;else yield s}async asyncReadAll(t){for await(const s of this.M.iterator(t))s.stream&&await this.I.asyncReadAll(s.stream)}}},690:(t,s,e)=>{const i=e(103).TextDecoder||TextDecoder,a=e(660);class r extends a{constructor({icyMetaInt:t,icyDetectionTimeout:s=2e3,icyCharacterEncoding:e="utf-8",...a}){super(a),this._=new i(e),this.A=t,this.T=s,this.v=this.B(),this.v.next()}*B(){if(yield*this.C())for(;;)this.R=this.A,yield*this.D(),yield*this.$(),this.R&&(yield*this.O());this.R=1/0,yield*this.D()}static parseIcyMetadata(t){const s=/(?<key>[^\0]+?)='(?<val>[^\0]*?)(;$|';|'$|$)/,e={};for(const i of t.match(new RegExp(s,"g"))||[]){const t=i.match(s);t&&(e[t.groups.key]=t.groups.val)}return e}get icyMetaInt(){return this.A}*C(){if(this.A>0)return!0;if(!this.T)return!1;this.L("Passed in Icy-MetaInt is invalid. Attempting to detect ICY Metadata.","See https://github.com/eshaz/icecast-metadata-js for information on how to properly request ICY Metadata.");const t=[null,83,116,114,101,97,109,84,105,116,108,101,61],s=Date.now();let e=0;for(;s+this.T>Date.now();){this.P=a.N(this.P,yield*this.G());t:for(;e<this.P.length-t.length;){for(let s=1;s<t.length;s++)if(this.P[s+e]!==t[s]){e++;continue t}return this.L(`Found ICY Metadata! Setting Icy-MetaInt to ${e}.`),this.A=e,!0}}return this.L("ICY Metadata not detected, but continuing anyway. Audio errors will occur if there is ICY metadata.",`Searched ${this.P.length} bytes for ${(Date.now()-s)/1e3} seconds.`,"Try increasing the `icyDetectionTimeout` value if ICY metadata is present in the stream."),this.j("icy"),!1}*D(){for(this.U.currentStreamBytesRemaining=this.R;this.R;)yield*this.Y(yield*super.k())}*$(){this.R=1;do{this.R=16*(yield*this.k())[0]}while(1===this.R);this.U.addMetadataLengthBytes(1)}*O(){this.U.currentMetadataBytesRemaining=this.R;const t=yield*this.k(this.R);this.U.addMetadataBytes(t.length),yield*this.V(r.parseIcyMetadata(this._.decode(t)))}}t.exports=r},660:(t,s,e)=>{const i=e(8),a=()=>{};class r{constructor(t){this.R=0,this.q=0,this.P=new Uint8Array(0),this.U=new i,this.F=t.onStream||a,this.H=t.onMetadata||a,this.j=t.onMetadataFailed||a,this.J=t.onError||a,this.W=t.enableLogging||!1,this.K=Promise.resolve(),this.X=Promise.resolve(),this.v=this.Z(),this.v.next()}*Z(){for(this.R=1/0;;)yield*this.Y(yield*this.k())}static N(t,s){const e=new Uint8Array(t.length+s.length);return e.set(t),e.set(s,t.length),e}*iterator(t){for(let s=this.v.next(t);s.value;s=this.v.next())yield s.value}readAll(t){for(let s=this.v.next(t);s.value;s=this.v.next());}async*asyncIterator(t){for(let s=this.v.next(t);s.value;s=this.v.next())await this.K,await this.X,yield s.value}async asyncReadAll(t){for(let s=this.v.next(t);s.value;s=this.v.next())await this.K,await this.X}L(...t){this.W&&console.warn("icecast-metadata-js",t.reduce(((t,s)=>t+"\n  "+s),"")),this.J(...t)}*Y(t){this.U.addStreamBytes(t.length);const s={stream:t,stats:this.U.stats};this.K=this.F(s),yield s}*V(t){const s={metadata:t,stats:this.U.stats};this.X=this.H(s),yield s}*k(t=0){for(this.q===this.P.length&&(this.P=yield*this.G(),this.q=0);this.P.length-this.q<t;)this.P=r.N(this.P,yield*this.G());const s=this.P.subarray(this.q,(t||this.R)+this.q);return this.U.addBytes(s.length),this.R=s.length<this.R?this.R-s.length:0,this.q+=s.length,s}*G(){let t;do{t=yield}while(!t||0===t.length);return this.U.addCurrentBytesRemaining(t.length),t}}t.exports=r},491:(t,s,e)=>{const i=e(103).TextDecoder||TextDecoder,a=e(660);t.exports=class extends a{constructor(t){super(t),this._=new i("utf-8"),this.v=this.tt(),this.v.next(),this.st=!1}*tt(){if(yield*this.et()){const t=yield*this.it();if(t)for(;yield*this.et();)this.st||(yield*this.O(t)),yield*this.D()}this.R=1/0,yield*this.D()}rt(t,s=0){return new DataView(Uint8Array.from([...t.subarray(s,s+4)]).buffer).getUint32(0,!0)}nt(t,s){return String.fromCharCode(...s).match(t)}*et(){let t=[];for(;t.length<=65307;){const s=yield*super.k(6);if(79===s[0]&&103===s[1]&&103===s[2]&&83===s[3]&&!(248&s[5])){this.st=1&s[5],this.q-=6,this.R+=6,this.U.ht-=6,this.U.ot+=6;break}t.push(s[0]),this.q-=4,this.U.ht-=4,this.U.ot+=4}if(t.length&&(yield*this.Y(Uint8Array.from(t))),t.length>65307)return this.L("This stream is not an OGG stream. No OGG metadata will be returned.","See https://github.com/eshaz/icecast-metadata-js for information on OGG metadata."),this.j("ogg"),!1;const s=yield*this.k(27),e=yield*this.k(s[26]);return this.R=e.reduce(((t,s)=>t+s),0),!0}*it(){const t=yield*this.k(8);return yield*this.D(),this.nt(/\x7fFLAC/,t.subarray(0,5))?{regex:/^[\x84|\x04]/,length:4}:this.nt(/OpusHead/,t.subarray(0,8))?{regex:/OpusTags/,length:8}:this.nt(/\x01vorbis/,t.subarray(0,7))?{regex:/\x03vorbis/,length:7}:void 0}*O({regex:t,length:s}){this.nt(t,yield*this.k(s))&&(yield*this.V(yield*this.ct()))}*D(){for(;this.R;)yield*this.k()}*k(t){const s=yield*super.k(t);return yield*this.Y(s),s}*G(){const t=yield*super.G();return this.U.currentStreamBytesRemaining=t.length,t}*ct(){const t=this.rt(yield*this.k(4));this.U.addMetadataBytes(4);const s=this._.decode(yield*this.k(t));this.U.addMetadataBytes(t);const e=this.rt(yield*this.k(4));this.U.addMetadataBytes(4);const i=[];for(let t=0;t<e;t++){const t=yield*this.k(4);this.U.addMetadataBytes(4),i.push(yield*this.k(this.rt(t))),this.U.addMetadataBytes(i[i.length-1].length)}return this.U.currentMetadataBytesRemaining=0,i.reduce(((t,s)=>{const e=s.indexOf(61),i=String.fromCharCode(...s.subarray(0,e)).toUpperCase(),a=this._.decode(s.subarray(e+1));return t[i]=t[i]?`${t[i]}; ${a}`:a,t}),{VENDOR_STRING:s})}}},8:t=>{t.exports=class{constructor(){this.ht=0,this.lt=0,this.dt=0,this.yt=0,this.ot=0,this.ut=0,this.gt=0}get stats(){return{totalBytesRead:this.ht,streamBytesRead:this.lt,metadataLengthBytesRead:this.dt,metadataBytesRead:this.yt,currentBytesRemaining:this.ot,currentStreamBytesRemaining:this.ut,currentMetadataBytesRemaining:this.gt}}set currentStreamBytesRemaining(t){this.ut+=t}set currentMetadataBytesRemaining(t){this.gt=t}addBytes(t){this.ht+=t,this.ot-=t}addStreamBytes(t){this.lt+=t,this.ut-=t}addMetadataLengthBytes(t){this.dt+=t}addMetadataBytes(t){this.yt+=t,this.gt-=t}addCurrentBytesRemaining(t){this.ot+=t}}},103:()=>{}},s={};function e(i){var a=s[i];if(void 0!==a)return a.exports;var r=s[i]={exports:{}};return t[i](r,r.exports,e),r.exports}e.n=t=>{var s=t&&t.ft?()=>t.default:()=>t;return e.d(s,{a:s}),s},e.d=(t,s)=>{for(var i in s)e.o(s,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},e.o=(t,s)=>Object.prototype.hasOwnProperty.call(t,s);var i={};(()=>{"use strict";e.d(i,{default:()=>G});e(344);var t=e(780),s=e.n(t);const a=()=>{};class r{constructor(t,{onStream:e=a,...i}){let n;this.bt=new ReadableStream({async start(a){n=new(s())({icyMetaInt:parseInt(t.headers.get("Icy-MetaInt")),...i,onStream:async t=>(a.enqueue(t.stream),e(t))});for await(const s of r.asyncIterator(t.body))await n.asyncReadAll(s);a.close()}}),this.St=n}get icyMetaInt(){return this.St.icyMetaInt}get readableStream(){return this.bt}async startReading(){try{for await(const t of r.asyncIterator(this.bt));}catch(t){if("AbortError"!==t.name)throw t}}static asyncIterator(t){const s=t.getReader();return{[Symbol.asyncIterator]:()=>({next:()=>s.read()})}}}const n=()=>{},h="stopped",o="fetching",c=new WeakMap,l=Symbol(),d=Symbol(),y=Symbol(),u=Symbol(),m=Symbol(),g=Symbol(),p=Symbol(),f=Symbol(),b=Symbol(),S=Symbol(),w=Symbol(),I=Symbol(),M=Symbol(),x=Symbol(),_=Symbol(),A=Symbol(),T=Symbol(),v=Symbol(),B=Symbol(),C=Symbol(),R=Symbol(),E=Symbol(),D=Symbol(),$=Symbol(),O=Symbol(),L=Symbol(),P=Symbol(),N=Symbol();class G{constructor(t,s={}){const e=t.split("/").slice(0,-1).join("/");c.set(this,{[T]:t,[m]:s.icestatsEndpoint||`${e}/status-json.xsl`,[f]:s.statsEndpoint||`${e}/stats`,[w]:s.nextsongsEndpoint||`${e}/nextsongs`,[x]:s.sevenhtmlEndpoint||`${e}/7.html`,[R]:s.sources||[],[E]:1e3*(s.interval||30),[D]:s.onStats||n,[$]:s.onStatsFetch||n,[v]:s.icyMetaInt,[B]:s.icyCharacterEncoding,[C]:s.icyDetectionTimeout,[l]:new AbortController,[y]:new AbortController,[g]:new AbortController,[b]:new AbortController,[I]:new AbortController,[_]:new AbortController,[O]:h})}static xml2Json(t){const s=t=>{if(!t.children.length)return Number.isNaN(Number(t.innerHTML))?t.innerHTML:Number(t.innerHTML);const e={};for(const i of t.children)i.nodeName in e?Array.isArray(e[i.nodeName])?e[i.nodeName].push(s(i)):e[i.nodeName]=[e[i.nodeName],s(i)]:e[i.nodeName]=s(i);return e};return s((t=>(new DOMParser).parseFromString(t,"application/xml"))(t))}get state(){return c.get(this)[O]}get icestatsEndpoint(){return c.get(this)[m]}get statsEndpoint(){return c.get(this)[f]}get nextsongsEndpoint(){return c.get(this)[w]}get sevenhtmlEndpoint(){return c.get(this)[x]}start(){c.get(this)[O]===h&&(c.get(this)[O]="running",this.fetch().then(c.get(this)[D]),c.get(this)[L]=setInterval((()=>{this.fetch().then(c.get(this)[D])}),c.get(this)[E]))}stop(){c.get(this)[O]!==h&&(c.get(this)[O]=h,clearInterval(c.get(this)[L]),c.get(this)[l].abort(),c.get(this)[y].abort(),c.get(this)[g].abort(),c.get(this)[b].abort(),c.get(this)[_].abort())}async fetch(){if(c.get(this)[O]!==o){const t=c.get(this)[O];c.get(this)[O]=o,c.get(this)[$](c.get(this)[R]);const s=[];c.get(this)[R].includes("icestats")&&s.push(this.getIcestats()),c.get(this)[R].includes("sevenhtml")&&s.push(this.getSevenhtml()),c.get(this)[R].includes("stats")&&s.push(this.getStats()),c.get(this)[R].includes("nextsongs")&&s.push(this.getNextsongs()),c.get(this)[R].includes("icy")&&s.push(this.getIcyMetadata()),c.get(this)[R].includes("ogg")&&s.push(this.getOggMetadata());const e=await Promise.all(s).then((t=>t.reduce(((t,s)=>({...t,...s})),{})));return c.get(this)[O]=c.get(this)[O]!==o?c.get(this)[O]:t,e}}async getIcestats(){return this[P]({status:p,endpoint:m,controller:g,mapper:t=>t.json()}).then((t=>({icestats:t&&t.icestats})))}async getSevenhtml(){return this[P]({status:A,endpoint:x,controller:_,mapper:async t=>(await t.text()).match(/(.*?)<\/body>/gi).map((t=>{const s=t.match(/(<body>|,)(?<stats>.*)<\/body>/i).groups.stats.split(",");return 7===s.length?{StreamTitle:s[6],currentListeners:parseInt(s[4]),peakListeners:parseInt(s[2]),maxListeners:parseInt(s[3]),bitrate:parseInt(s[5]),status:parseInt(s[1]),serverListeners:parseInt(s[0])}:{StreamTitle:s[4],currentListeners:parseInt(s[2]),peakListeners:parseInt(s[0]),maxListeners:parseInt(s[1]),bitrate:parseInt(s[3])}}))}).then((t=>({sevenhtml:t})))}async getStats(){return this[P]({status:S,endpoint:f,controller:b,mapper:async t=>G.xml2Json(await t.text()).SHOUTCASTSERVER.STREAMSTATS}).then((t=>({stats:t})))}async getNextsongs(){return this[P]({status:M,endpoint:w,controller:I,mapper:async t=>G.xml2Json(await t.text()).SHOUTCASTSERVER.NEXTSONGS}).then((t=>({nextsongs:t})))}async getIcyMetadata(){return this[N]({status:d,endpoint:T,controller:l,metadataType:"icy",headers:{"Icy-MetaData":1}})}async getOggMetadata(){return this[N]({status:u,endpoint:T,controller:y,metadataType:"ogg"})}async[N]({status:t,endpoint:s,controller:e,headers:i,metadataType:a}){return this[P]({status:t,endpoint:s,controller:e,headers:i,mapper:async t=>new Promise((s=>{new r(t,{onMetadata:({metadata:t})=>{c.get(this)[e].abort(),s(t)},onMetadataFailed:()=>{c.get(this)[e].abort(),s()},metadataTypes:a,icyMetaInt:c.get(this)[v],icyCharacterEncoding:c.get(this)[B],icyDetectionTimeout:c.get(this)[C]}).startReading()}))}).then((t=>({[a]:t})))}async[P]({status:t,endpoint:s,controller:e,mapper:i,headers:a={}}){if(!c.get(this)[t])return c.get(this)[t]=!0,fetch(c.get(this)[s],{method:"GET",headers:a,signal:c.get(this)[e].signal}).then((t=>{if(!t.ok)throw new Error(`HTTP Error ${t.status}`);return t})).then(i).catch((t=>{"AbortError"!==t.name&&console.warn(`Failed to fetch ${c.get(this)[s]}`,t)})).finally((()=>{c.get(this)[t]=!1,c.get(this)[e]=new AbortController}))}}})(),IcecastMetadataStats=i.default})();
//# sourceMappingURL=icecast-metadata-stats-0.1.1.min.js.map